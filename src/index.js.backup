#!/usr/bin/env node

const { Command } = require('commander');
const SSEService = require('./services/sse-service');
const SZSEService = require('./services/szse-service');
const EastMoneyService = require('./services/eastmoney-service');
const LimitUpService = require('./services/limitup-service');
const LimitDownService = require('./services/limitdown-service');

// åˆ›å»ºæœåŠ¡å®ä¾‹
const sseService = new SSEService();
const szseService = new SZSEService();
const eastMoneyService = new EastMoneyService();
const limitUpService = new LimitUpService();
const limitDownService = new LimitDownService();
const CacheService = require('./services/cache-service');
const FileUtils = require('./utils/file-utils');
const DateUtils = require('./utils/date-utils');
const logger = require('./utils/logger');
const { EXCHANGES } = require('./config/constants');

const program = new Command();

// åˆå§‹åŒ–ç›®å½•
async function initializeDirectories() {
  await FileUtils.initDirectories();
}

/**
 * è·å–å½“æ—¥è‚¡ç¥¨æ•°æ®
 */
async function fetchCurrentData(options) {
  try {
    console.log('å¼€å§‹è·å–å½“æ—¥è‚¡ç¥¨æ•°æ®...');

    const results = {};

    // è·å–ä¸Šäº¤æ‰€æ•°æ®
    if (!options.exchange || options.exchange.toLowerCase() === EXCHANGES.SSE.toLowerCase()) {
      console.log('æ­£åœ¨è·å–ä¸Šäº¤æ‰€(SSE)æ•°æ®...');
      results.sse = await sseService.getCurrentStockData(!options.noCache);

      if (results.sse) {
        console.log(`âœ… ä¸Šäº¤æ‰€æ•°æ®è·å–æˆåŠŸï¼Œå…± ${results.sse.data.length} æ¡è®°å½•`);
      } else {
        console.log('âŒ ä¸Šäº¤æ‰€æ•°æ®è·å–å¤±è´¥');
      }
    }

    // è·å–æ·±äº¤æ‰€æ•°æ®
    if (!options.exchange || options.exchange.toLowerCase() === EXCHANGES.SZSE.toLowerCase()) {
      console.log('æ­£åœ¨è·å–æ·±äº¤æ‰€(SZSE)æ•°æ®ï¼ˆé€šè¿‡ä¸œæ–¹è´¢å¯ŒAPIï¼‰...');
      results.szse = await eastMoneyService.getCurrentStockData(!options.noCache);

      if (results.szse) {
        console.log(`âœ… æ·±äº¤æ‰€æ•°æ®è·å–æˆåŠŸï¼Œå…± ${results.szse.data.length} æ¡è®°å½•`);
        if (results.szse.source) {
          console.log(`ğŸ“¡ æ•°æ®æ¥æº: ${results.szse.source}`);
        }
      } else {
        console.log('âŒ æ·±äº¤æ‰€æ•°æ®è·å–å¤±è´¥');
      }
    }

    // æ˜¾ç¤ºæ±‡æ€»ä¿¡æ¯
    const sseCount = results.sse ? results.sse.data.length : 0;
    const szseCount = results.szse ? results.szse.data.length : 0;
    console.log(`\\nğŸ“Š æ•°æ®è·å–æ±‡æ€»:`);
    console.log(`   ä¸Šäº¤æ‰€: ${sseCount} æ¡è®°å½•`);
    console.log(`   æ·±äº¤æ‰€: ${szseCount} æ¡è®°å½•`);
    console.log(`   æ€»è®¡: ${sseCount + szseCount} æ¡è®°å½•`);

    return results;
  } catch (error) {
    await logger.error('è·å–å½“æ—¥æ•°æ®å¤±è´¥', error);
    console.error('âŒ è·å–å½“æ—¥æ•°æ®å¤±è´¥:', error.message);
    console.error('è¯¦ç»†é”™è¯¯:', error.stack);
  }
}

/**
 * è·å–æŒ‡å®šæ—¥æœŸçš„è‚¡ç¥¨æ•°æ®
 */
async function fetchDateData(date, options) {
  try {
    if (!DateUtils.isValidDate(date)) {
      console.error('âŒ æ— æ•ˆçš„æ—¥æœŸæ ¼å¼ï¼Œè¯·ä½¿ç”¨ YYYY-MM-DD æ ¼å¼');
      return;
    }

    console.log(`å¼€å§‹è·å– ${date} çš„è‚¡ç¥¨æ•°æ®...`);

    const results = {};

    // è·å–ä¸Šäº¤æ‰€æ•°æ®
    if (!options.exchange || options.exchange === EXCHANGES.SSE) {
      console.log(`æ­£åœ¨è·å–ä¸Šäº¤æ‰€(SSE) ${date} çš„æ•°æ®...`);
      results.sse = await sseService.getHistoricalStockData(date, !options.noCache);

      if (results.sse) {
        console.log(`âœ… ä¸Šäº¤æ‰€ ${date} æ•°æ®è·å–æˆåŠŸï¼Œå…± ${results.sse.data.length} æ¡è®°å½•`);
      } else {
        console.log(`âŒ ä¸Šäº¤æ‰€ ${date} æ•°æ®è·å–å¤±è´¥`);
      }
    }

    // è·å–æ·±äº¤æ‰€æ•°æ®
    if (!options.exchange || options.exchange === EXCHANGES.SZSE) {
      console.log(`æ­£åœ¨è·å–æ·±äº¤æ‰€(SZSE) ${date} çš„æ•°æ®...`);
      results.szse = await eastMoneyService.getHistoricalStockData(date, !options.noCache);

      if (results.szse) {
        console.log(`âœ… æ·±äº¤æ‰€ ${date} æ•°æ®è·å–æˆåŠŸï¼Œå…± ${results.szse.data.length} æ¡è®°å½•`);
      } else {
        console.log(`âŒ æ·±äº¤æ‰€ ${date} æ•°æ®è·å–å¤±è´¥`);
      }
    }

    // æ˜¾ç¤ºæ±‡æ€»ä¿¡æ¯
    const sseCount = results.sse ? results.sse.data.length : 0;
    const szseCount = results.szse ? results.szse.data.length : 0;
    console.log(`\\nğŸ“Š ${date} æ•°æ®è·å–æ±‡æ€»:`);
    console.log(`   ä¸Šäº¤æ‰€: ${sseCount} æ¡è®°å½•`);
    console.log(`   æ·±äº¤æ‰€: ${szseCount} æ¡è®°å½•`);
    console.log(`   æ€»è®¡: ${sseCount + szseCount} æ¡è®°å½•`);

    return results;
  } catch (error) {
    await logger.error(`è·å– ${date} æ•°æ®å¤±è´¥`, error);
    console.error(`âŒ è·å– ${date} æ•°æ®å¤±è´¥:`, error.message);
  }
}

/**
 * æ‰¹é‡è·å–æ—¥æœŸèŒƒå›´çš„æ•°æ®
 */
async function fetchRangeData(startDate, endDate, options) {
  try {
    if (!DateUtils.isValidDate(startDate) || !DateUtils.isValidDate(endDate)) {
      console.error('âŒ æ— æ•ˆçš„æ—¥æœŸæ ¼å¼ï¼Œè¯·ä½¿ç”¨ YYYY-MM-DD æ ¼å¼');
      return;
    }

    console.log(`å¼€å§‹æ‰¹é‡è·å– ${startDate} åˆ° ${endDate} çš„è‚¡ç¥¨æ•°æ®...`);

    const results = {};

    // è·å–ä¸Šäº¤æ‰€æ•°æ®
    if (!options.exchange || options.exchange === EXCHANGES.SSE) {
      console.log(`æ­£åœ¨æ‰¹é‡è·å–ä¸Šäº¤æ‰€(SSE)æ•°æ®...`);
      results.sse = await sseService.getStockDataRange(startDate, endDate, !options.noCache);
      console.log(`âœ… ä¸Šäº¤æ‰€æ‰¹é‡æ•°æ®è·å–å®Œæˆï¼Œå…± ${results.sse.length} å¤©çš„æ•°æ®`);
    }

    // è·å–æ·±äº¤æ‰€æ•°æ®
    if (!options.exchange || options.exchange === EXCHANGES.SZSE) {
      console.log(`æ­£åœ¨æ‰¹é‡è·å–æ·±äº¤æ‰€(SZSE)æ•°æ®...`);
      results.szse = await eastMoneyService.getStockDataRange(startDate, endDate, !options.noCache);
      console.log(`âœ… æ·±äº¤æ‰€æ‰¹é‡æ•°æ®è·å–å®Œæˆï¼Œå…± ${results.szse.length} å¤©çš„æ•°æ®`);
    }

    // æ˜¾ç¤ºæ±‡æ€»ä¿¡æ¯
    const sseDays = results.sse ? results.sse.length : 0;
    const szseDays = results.szse ? results.szse.length : 0;
    console.log(`\\nğŸ“Š æ‰¹é‡æ•°æ®è·å–æ±‡æ€»:`);
    console.log(`   ä¸Šäº¤æ‰€: ${sseDays} å¤©æ•°æ®`);
    console.log(`   æ·±äº¤æ‰€: ${szseDays} å¤©æ•°æ®`);

    return results;
  } catch (error) {
    await logger.error('æ‰¹é‡è·å–æ•°æ®å¤±è´¥', error);
    console.error('âŒ æ‰¹é‡è·å–æ•°æ®å¤±è´¥:', error.message);
  }
}

/**
 * åˆ·æ–°ç¼“å­˜æ•°æ®
 */
async function refreshCacheData(date, options) {
  try {
    const targetDate = date || DateUtils.getCurrentDate();

    console.log(`å¼€å§‹åˆ·æ–° ${targetDate} çš„ç¼“å­˜æ•°æ®...`);

    const results = {};

    // åˆ·æ–°ä¸Šäº¤æ‰€æ•°æ®
    if (!options.exchange || options.exchange === EXCHANGES.SSE) {
      console.log(`æ­£åœ¨åˆ·æ–°ä¸Šäº¤æ‰€(SSE) ${targetDate} çš„æ•°æ®...`);
      results.sse = await sseService.refreshStockData(targetDate);

      if (results.sse) {
        console.log(`âœ… ä¸Šäº¤æ‰€ ${targetDate} æ•°æ®åˆ·æ–°æˆåŠŸï¼Œå…± ${results.sse.data.length} æ¡è®°å½•`);
      } else {
        console.log(`âŒ ä¸Šäº¤æ‰€ ${targetDate} æ•°æ®åˆ·æ–°å¤±è´¥`);
      }
    }

    // åˆ·æ–°æ·±äº¤æ‰€æ•°æ®
    if (!options.exchange || options.exchange === EXCHANGES.SZSE) {
      console.log(`æ­£åœ¨åˆ·æ–°æ·±äº¤æ‰€(SZSE) ${targetDate} çš„æ•°æ®...`);
      results.szse = await eastMoneyService.refreshStockData(targetDate);

      if (results.szse) {
        console.log(`âœ… æ·±äº¤æ‰€ ${targetDate} æ•°æ®åˆ·æ–°æˆåŠŸï¼Œå…± ${results.szse.data.length} æ¡è®°å½•`);
      } else {
        console.log(`âŒ æ·±äº¤æ‰€ ${targetDate} æ•°æ®åˆ·æ–°å¤±è´¥`);
      }
    }

    return results;
  } catch (error) {
    await logger.error('åˆ·æ–°ç¼“å­˜å¤±è´¥', error);
    console.error('âŒ åˆ·æ–°ç¼“å­˜å¤±è´¥:', error.message);
  }
}

/**
 * æ˜¾ç¤ºç¼“å­˜çŠ¶æ€
 */
async function showCacheStatus() {
  try {
    console.log('ç¼“å­˜çŠ¶æ€ä¿¡æ¯:');

    // ä¸Šäº¤æ‰€ç¼“å­˜çŠ¶æ€
    const sseFiles = await CacheService.listCachedFiles(EXCHANGES.SSE);
    console.log(`\\nğŸ“ ä¸Šäº¤æ‰€(SSE)ç¼“å­˜:`);
    console.log(`   æ–‡ä»¶æ•°é‡: ${sseFiles.length}`);
    if (sseFiles.length > 0) {
      console.log(`   æœ€æ–°æ–‡ä»¶: ${sseFiles[0].date}`);
      console.log(`   æœ€æ—§æ–‡ä»¶: ${sseFiles[sseFiles.length - 1].date}`);
    }

    // æ·±äº¤æ‰€ç¼“å­˜çŠ¶æ€
    const szseFiles = await CacheService.listCachedFiles(EXCHANGES.SZSE);
    console.log(`\\nğŸ“ æ·±äº¤æ‰€(SZSE)ç¼“å­˜:`);
    console.log(`   æ–‡ä»¶æ•°é‡: ${szseFiles.length}`);
    if (szseFiles.length > 0) {
      console.log(`   æœ€æ–°æ–‡ä»¶: ${szseFiles[0].date}`);
      console.log(`   æœ€æ—§æ–‡ä»¶: ${szseFiles[szseFiles.length - 1].date}`);
    }
  } catch (error) {
    await logger.error('è·å–ç¼“å­˜çŠ¶æ€å¤±è´¥', error);
    console.error('âŒ è·å–ç¼“å­˜çŠ¶æ€å¤±è´¥:', error.message);
  }
}

/**
 * æ¸…ç†è¿‡æœŸç¼“å­˜
 */
async function cleanExpiredCache(days) {
  try {
    const keepDays = days || 30;
    console.log(`å¼€å§‹æ¸…ç†è¶…è¿‡ ${keepDays} å¤©çš„è¿‡æœŸç¼“å­˜...`);

    const sseCleaned = await CacheService.cleanExpiredCache(EXCHANGES.SSE, keepDays);
    const szseCleaned = await CacheService.cleanExpiredCache(EXCHANGES.SZSE, keepDays);

    const totalCleaned = sseCleaned + szseCleaned;
    console.log(`âœ… ç¼“å­˜æ¸…ç†å®Œæˆï¼Œå…±æ¸…ç† ${totalCleaned} ä¸ªæ–‡ä»¶`);
    console.log(`   ä¸Šäº¤æ‰€: ${sseCleaned} ä¸ªæ–‡ä»¶`);
    console.log(`   æ·±äº¤æ‰€: ${szseCleaned} ä¸ªæ–‡ä»¶`);
  } catch (error) {
    await logger.error('æ¸…ç†ç¼“å­˜å¤±è´¥', error);
    console.error('âŒ æ¸…ç†ç¼“å­˜å¤±è´¥:', error.message);
  }
}

// é…ç½®å‘½ä»¤è¡Œç¨‹åº
program
  .name('stock-fetcher')
  .description('è‚¡ç¥¨è¡Œæƒ…æ•°æ®æŠ“å–å·¥å…·')
  .version('1.0.0');

// è·å–å½“æ—¥æ•°æ®
program
  .command('current')
  .description('è·å–å½“æ—¥è‚¡ç¥¨æ•°æ®')
  .option('-e, --exchange <exchange>', 'æŒ‡å®šäº¤æ˜“æ‰€ (sse/szse)')
  .option('--no-cache', 'ä¸ä½¿ç”¨ç¼“å­˜')
  .action(async (options) => {
    await initializeDirectories();
    await fetchCurrentData(options);
  });

// è·å–æŒ‡å®šæ—¥æœŸæ•°æ®
program
  .command('date <date>')
  .description('è·å–æŒ‡å®šæ—¥æœŸçš„è‚¡ç¥¨æ•°æ® (YYYY-MM-DD)')
  .option('-e, --exchange <exchange>', 'æŒ‡å®šäº¤æ˜“æ‰€ (sse/szse)')
  .option('--no-cache', 'ä¸ä½¿ç”¨ç¼“å­˜')
  .action(async (date, options) => {
    await initializeDirectories();
    await fetchDateData(date, options);
  });

// æ‰¹é‡è·å–æ—¥æœŸèŒƒå›´æ•°æ®
program
  .command('range <startDate> <endDate>')
  .description('æ‰¹é‡è·å–æ—¥æœŸèŒƒå›´çš„è‚¡ç¥¨æ•°æ®')
  .option('-e, --exchange <exchange>', 'æŒ‡å®šäº¤æ˜“æ‰€ (sse/szse)')
  .option('--no-cache', 'ä¸ä½¿ç”¨ç¼“å­˜')
  .action(async (startDate, endDate, options) => {
    await initializeDirectories();
    await fetchRangeData(startDate, endDate, options);
  });

// åˆ·æ–°ç¼“å­˜
program
  .command('refresh [date]')
  .description('åˆ·æ–°æŒ‡å®šæ—¥æœŸçš„ç¼“å­˜æ•°æ®ï¼Œé»˜è®¤ä¸ºå½“å‰æ—¥æœŸ')
  .option('-e, --exchange <exchange>', 'æŒ‡å®šäº¤æ˜“æ‰€ (sse/szse)')
  .action(async (date, options) => {
    await initializeDirectories();
    await refreshCacheData(date, options);
  });

// æ˜¾ç¤ºç¼“å­˜çŠ¶æ€
program
  .command('cache-status')
  .description('æ˜¾ç¤ºç¼“å­˜çŠ¶æ€ä¿¡æ¯')
  .action(async () => {
    await showCacheStatus();
  });

// æ¸…ç†è¿‡æœŸç¼“å­˜
program
  .command('clean-cache [days]')
  .description('æ¸…ç†è¿‡æœŸçš„ç¼“å­˜æ–‡ä»¶ï¼Œé»˜è®¤ä¿ç•™30å¤©')
  .action(async (days) => {
    await cleanExpiredCache(days);
  });

/**
 * ç”Ÿæˆæ¶¨åœæ¿å¤©æ¢¯
 */
async function generateLimitUpLadder(date, options) {
  try {
    console.log('å¼€å§‹ç”Ÿæˆæ¶¨åœæ¿å¤©æ¢¯...');

    const targetDate = date || DateUtils.getCurrentDate();
    console.log(`ç›®æ ‡æ—¥æœŸ: ${targetDate}`);

    // ç”Ÿæˆå¹¶ä¿å­˜å¤©æ¢¯æ•°æ®
    const shouldSave = !options.noSave;
    const ladderData = await limitUpService.generateAndSave(targetDate, shouldSave);

    if (ladderData) {
      console.log(`âœ… æ¶¨åœæ¿å¤©æ¢¯ç”ŸæˆæˆåŠŸ!`);
      console.log(`ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:`);
      console.log(`   æ€»æ•°é‡: ${ladderData.totalCount}`);
      console.log(`   ä¸»æ¿: ${ladderData.mainBoardCount}`);
      console.log(`   åˆ›ä¸šæ¿/ç§‘åˆ›æ¿: ${ladderData.growthBoardCount}`);
      console.log(`   è®¡ç®—æ–¹æ³•: ${ladderData.calculationMethod}`);

      if (ladderData.stocks.length > 0) {
        console.log(`\\nğŸ† æ¶¨åœå† å†›:`);
        const topStock = ladderData.stocks[0];
        console.log(`   ${topStock.name} (${topStock.code})`);
        console.log(`   æ¶¨å¹…: ${topStock.actualChangeRate}%`);
        console.log(`   æˆäº¤é¢: ${topStock.amount ? (topStock.amount / 100000000).toFixed(2) + 'äº¿' : 'N/A'}`);
      }

      if (!options.noSave) {
        console.log(`\\nğŸ’¾ æ•°æ®å·²ä¿å­˜åˆ°: data/limitup/${targetDate}.json`);
      }
    } else {
      console.log('âŒ æ¶¨åœæ¿å¤©æ¢¯ç”Ÿæˆå¤±è´¥');
    }

  } catch (error) {
    await logger.error('ç”Ÿæˆæ¶¨åœæ¿å¤©æ¢¯å¤±è´¥', error);
    console.error('âŒ ç”Ÿæˆæ¶¨åœæ¿å¤©æ¢¯å¤±è´¥:', error.message);
  }
}

/**
 * æ˜¾ç¤ºæ¶¨åœæ¿å¤©æ¢¯ç»Ÿè®¡
 */
async function showLimitUpStats(date) {
  try {
    const targetDate = date || DateUtils.getCurrentDate();
    console.log(`æ¶¨åœæ¿å¤©æ¢¯ç»Ÿè®¡ - ${targetDate}:`);

    const stats = await limitUpService.getLadderStatistics(targetDate);

    if (stats.hasData) {
      console.log(`âœ… æ•°æ®å¯ç”¨`);
      console.log(`ğŸ“Š æ¶¨åœè‚¡ç¥¨æ•°é‡: ${stats.totalCount}`);
      console.log(`   ä¸»æ¿: ${stats.mainBoardCount}`);
      console.log(`   åˆ›ä¸šæ¿/ç§‘åˆ›æ¿: ${stats.growthBoardCount}`);

      if (stats.topStock) {
        console.log(`ğŸ† æ¶¨åœå† å†›: ${stats.topStock.name} (${stats.topStock.code}) æ¶¨å¹…${stats.topStock.changeRate}%`);
      }
    } else {
      console.log(`âŒ ${stats.message}`);
    }

  } catch (error) {
    await logger.error('æ˜¾ç¤ºæ¶¨åœæ¿ç»Ÿè®¡å¤±è´¥', error);
    console.error('âŒ æ˜¾ç¤ºæ¶¨åœæ¿ç»Ÿè®¡å¤±è´¥:', error.message);
  }
}

// ç”Ÿæˆæ¶¨åœæ¿å¤©æ¢¯
program
  .command('limitup [date]')
  .description('ç”Ÿæˆæ¶¨åœæ¿å¤©æ¢¯ (åŸºäºä»·æ ¼åˆ¤æ–­ï¼Œæ’é™¤åœç‰Œã€STã€åŒ—äº¤æ‰€è‚¡ç¥¨)')
  .option('--no-save', 'ä¸ä¿å­˜åˆ°æ–‡ä»¶')
  .action(async (date, options) => {
    await initializeDirectories();
    await generateLimitUpLadder(date, options);
  });

// æ¶¨åœæ¿å¤©æ¢¯ç»Ÿè®¡
program
  .command('limitup-stats [date]')
  .description('æ˜¾ç¤ºæ¶¨åœæ¿å¤©æ¢¯ç»Ÿè®¡ä¿¡æ¯')
  .action(async (date) => {
    await showLimitUpStats(date);
  });

/**
 * ç”Ÿæˆç‚¸æ¿è‚¡åˆ—è¡¨
 */
async function generateExplodedList(date, options) {
  try {
    console.log('å¼€å§‹ç”Ÿæˆç‚¸æ¿è‚¡åˆ—è¡¨...');

    const targetDate = date || DateUtils.getCurrentDate();
    console.log(`ç›®æ ‡æ—¥æœŸ: ${targetDate}`);

    // ç”Ÿæˆå¹¶ä¿å­˜åˆ—è¡¨æ•°æ®
    const listData = await limitDownService.generateAndSave(targetDate, !options.noSave);

    if (listData) {
      console.log(`âœ… ç‚¸æ¿è‚¡åˆ—è¡¨ç”ŸæˆæˆåŠŸ!`);
      console.log(`ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:`);
      console.log(`   æ€»æ•°é‡: ${listData.totalCount}`);

      if (listData.stocks.length > 0) {
        console.log(`\\nğŸ“‹ ç‚¸æ¿è‚¡ç¥¨åˆ—è¡¨:`);
        listData.stocks.forEach((stock, index) => {
          console.log(`   ${index + 1}. ${stock.name} (${stock.code}) - å¼€æ¿${stock.dropRate}% - ${stock.explodedType}`);
        });
      }

      if (!options.noSave) {
        console.log(`\\nğŸ’¾ æ•°æ®å·²ä¿å­˜åˆ°: data/limitdown/${targetDate}.json`);
      }
    } else {
      console.log('âŒ ç‚¸æ¿è‚¡åˆ—è¡¨ç”Ÿæˆå¤±è´¥');
    }

  } catch (error) {
    await logger.error('ç”Ÿæˆç‚¸æ¿è‚¡åˆ—è¡¨å¤±è´¥', error);
    console.error('âŒ ç”Ÿæˆç‚¸æ¿è‚¡åˆ—è¡¨å¤±è´¥:', error.message);
  }
}

// ç”Ÿæˆç‚¸æ¿è‚¡åˆ—è¡¨
program
  .command('limitdown [date]')
  .description('ç”Ÿæˆç‚¸æ¿è‚¡åˆ—è¡¨ (æ’é™¤åœç‰Œã€STã€åŒ—äº¤æ‰€è‚¡ç¥¨)')
  .option('--no-save', 'ä¸ä¿å­˜åˆ°æ–‡ä»¶')
  .action(async (date, options) => {
    await initializeDirectories();
    await generateExplodedList(date, options);
  });

// å¦‚æœæ²¡æœ‰æä¾›å‘½ä»¤å‚æ•°ï¼Œé»˜è®¤æ‰§è¡Œè·å–å½“æ—¥æ•°æ®
if (process.argv.length <= 2) {
  console.log('ğŸš€ è‚¡ç¥¨è¡Œæƒ…æ•°æ®æŠ“å–å·¥å…·å¯åŠ¨ä¸­...');
  initializeDirectories().then(() => {
    console.log('è·å–å½“æ—¥æ•°æ®ï¼Œä½¿ç”¨ --help æŸ¥çœ‹æ›´å¤šé€‰é¡¹\\n');
    fetchCurrentData({ exchange: null, noCache: false });
  });
} else {
  program.parse();
}

// å¤„ç†æœªæ•è·çš„å¼‚å¸¸
process.on('uncaughtException', async (error) => {
  await logger.error('æœªæ•è·çš„å¼‚å¸¸', error);
  console.error('âŒ ç¨‹åºå‡ºç°å¼‚å¸¸:', error.message);
  process.exit(1);
});

process.on('unhandledRejection', async (reason, promise) => {
  await logger.error('æœªå¤„ç†çš„Promiseæ‹’ç»', new Error(reason));
  console.error('âŒ Promiseè¢«æ‹’ç»:', reason);
  process.exit(1);
});